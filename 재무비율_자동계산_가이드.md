# 재무비율 자동 계산 문제 해결 가이드

## 🔴 문제 상황

**사용자 질문:**
"SNT다이내믹스의 매출액과 영업이익, 영업이익률 조회해줘"

**시스템 응답 (문제):**
```
매출액: 336,666,812,235원
영업이익: 47,289,352,211원
영업이익률에 대한 정보는 제공되지 않았습니다. ❌
```

**기대 응답:**
```
매출액: 336,666,812,235원
영업이익: 47,289,352,211원
영업이익률: 14.05% (계산: 47,289,352,211 ÷ 336,666,812,235 × 100) ✅
```

## 🔍 원인 분석

### 문제의 근본 원인

1. **LLM이 영업이익률을 DB에서 직접 조회하려고 시도**
   - 영업이익률 컬럼은 DB에 존재하지 않음
   - SQL 쿼리에 영업이익률을 포함시켰으나 결과 없음
   - "정보가 제공되지 않았습니다"라고 답변

2. **`generate_answer` 함수에 비율 계산 로직 없음**
   - SQL 결과를 그대로 답변하는 것만 지시
   - 매출액과 영업이익이 있으면 자동으로 계산해야 하는데 지침이 없음

### 데이터베이스 구조

```sql
-- income_statement 테이블에는 비율 컬럼이 없음!
SELECT 항목명 FROM income_statement WHERE 회사명 = 'SNT다이내믹스';

-- 결과:
매출액 ✅
영업이익 ✅
순이익 (당기순이익) ✅
영업이익률 ❌ (없음!)
순이익률 ❌ (없음!)
```

## ✅ 해결 방법

### 1. `tools.py` - `generate_answer` 함수 수정

#### Before (문제)
```python
def generate_answer(state: State):
    prompt = (
        "Given the following user question, corresponding SQL query, "
        "and SQL result, answer the user question in Korean.\n\n"
        f'Question: {state["question"]}\n'
        f'SQL Query: {state["query"]}\n'
        f'SQL Result: {state["result"]}\n\n'
        "**CRITICAL: Number Formatting Rules**\n"
        "- Use the EXACT numbers from SQL Result\n"
        # ... 숫자 포맷팅 규칙만 있고 비율 계산 로직 없음!
    )
```

#### After (해결)
```python
def generate_answer(state: State):
    prompt = (
        "Given the following user question, corresponding SQL query, "
        "and SQL result, answer the user question in Korean.\n\n"
        f'Question: {state["question"]}\n'
        f'SQL Query: {state["query"]}\n'
        f'SQL Result: {state["result"]}\n\n'
        "**CRITICAL: Financial Ratio Calculation (재무비율 자동 계산)**\n"
        "If the question asks for ratios (영업이익률, 순이익률, ROE, ROA, 부채비율, etc.),\n"
        "and SQL Result contains the necessary data, YOU MUST CALCULATE IT!\n\n"
        "**Common Ratios:**\n"
        "1. 영업이익률 = (영업이익 / 매출액 or 영업수익) × 100\n"
        "2. 순이익률 = (순이익 / 매출액 or 영업수익) × 100\n"
        "3. ROE = (순이익 / 자본총계) × 100\n"
        "4. ROA = (순이익 / 자산총계) × 100\n"
        "5. 부채비율 = (부채총계 / 자본총계) × 100\n\n"
        "**How to Calculate:**\n"
        "1. Remove commas: '47,687,046,619' → 47687046619\n"
        "2. Divide and multiply by 100\n"
        "3. Round to 2 decimal places\n"
        "4. Show calculation: '영업이익률 = (47,289 ÷ 336,666) × 100 = 14.05%'\n\n"
        "**NEVER say '영업이익률에 대한 정보는 제공되지 않았습니다' if you can calculate it!**\n"
        # ... (나머지 숫자 포맷팅 규칙)
    )
```

### 2. 재무비율 계산 공식

| 비율 | 공식 | 필요 데이터 |
|------|------|------------|
| 영업이익률 | (영업이익 / 매출액) × 100 | 영업이익, 매출액 or 영업수익 |
| 순이익률 | (순이익 / 매출액) × 100 | 순이익, 매출액 or 영업수익 |
| ROE | (순이익 / 자본총계) × 100 | 순이익, 자본총계 |
| ROA | (순이익 / 자산총계) × 100 | 순이익, 자산총계 |
| 부채비율 | (부채총계 / 자본총계) × 100 | 부채총계, 자본총계 |

### 3. 계산 예시

#### SNT다이내믹스 영업이익률
```python
# SQL 결과
매출액 = 336,666,812,235
영업이익 = 47,289,352,211

# 계산
영업이익률 = (47,289,352,211 / 336,666,812,235) × 100
         = 0.140498... × 100
         = 14.05%

# 답변 예시
"영업이익률: 14.05% (계산: 47,289,352,211 ÷ 336,666,812,235 × 100)"
```

#### 삼성전자 ROE (예시)
```python
# SQL 결과
순이익 = 13,339,313,000,000
자본총계 = 300,000,000,000,000

# 계산
ROE = (13,339,313,000,000 / 300,000,000,000,000) × 100
    = 0.04446... × 100
    = 4.45%

# 답변 예시
"ROE: 4.45% (계산: 13,339,313,000,000 ÷ 300,000,000,000,000 × 100)"
```

## 📋 프롬프트 업데이트 상세

### 추가된 핵심 규칙

1. **비율 계산 의무화**
   ```
   "If the question asks for ratios (영업이익률, 순이익률, ROE, ROA, 부채비율, etc.),
   and SQL Result contains the necessary data, YOU MUST CALCULATE IT!"
   ```

2. **계산 방법 명시**
   ```
   1. Remove commas from numbers
   2. Divide and multiply by 100 for percentage
   3. Round to 2 decimal places
   4. Show calculation in answer
   ```

3. **예시 제공**
   ```
   Question: 'SNT다이내믹스의 매출액과 영업이익, 영업이익률 조회해줘'
   SQL Result: 매출액: 336,666,812,235, 영업이익: 47,289,352,211
   Answer: '매출액: 336,666,812,235원, 영업이익: 47,289,352,211원, 
            영업이익률: 14.05% (계산: 47,289,352,211 ÷ 336,666,812,235 × 100)'
   ```

4. **금지 사항 명시**
   ```
   **NEVER say '영업이익률에 대한 정보는 제공되지 않았습니다' if you can calculate it!**
   ```

5. **Bad/Good Examples 추가**
   ```
   Bad Example:
   - ❌ '영업이익률에 대한 정보는 제공되지 않았습니다' (when you can calculate it!)
   
   Good Example:
   - ✅ '영업이익률은 18.22%입니다 (계산: 8,675,711,602 ÷ 47,687,046,619 × 100)'
   ```

## 🧪 테스트 시나리오

### 시나리오 1: 단일 회사 영업이익률
```
Query: "SNT다이내믹스의 매출액과 영업이익, 영업이익률 조회해줘"

Expected Output:
매출액: 336,666,812,235원
영업이익: 47,289,352,211원
영업이익률: 14.05% (계산: 47,289,352,211 ÷ 336,666,812,235 × 100) ✅
```

### 시나리오 2: 순이익률
```
Query: "SNT다이내믹스의 순이익률은?"

SQL Result:
- 매출액: 336,666,812,235
- 당기순이익: 45,782,467,110

Expected Output:
순이익률: 13.60% (계산: 45,782,467,110 ÷ 336,666,812,235 × 100) ✅
```

### 시나리오 3: 비교 분석 (Iterative RAG)
```
Query: "삼성전자와 SK하이닉스의 영업이익률 비교"

Step 1: Query 삼성전자 매출액, 영업이익
Step 2: Query SK하이닉스 매출액, 영업이익
Step 3: Calculate both ratios and compare ✅
```

### 시나리오 4: ROE 계산
```
Query: "삼성전자의 ROE는?"

SQL Result (JOIN):
- 순이익: 13,339,313,000,000 (income_statement)
- 자본총계: 300,000,000,000,000 (balance_sheet)

Expected Output:
ROE: 4.45% (계산: 13,339,313,000,000 ÷ 300,000,000,000,000 × 100) ✅
```

## 🎯 동작 흐름

```
User: "SNT다이내믹스의 매출액과 영업이익, 영업이익률 조회해줘"
  ↓
LLM (write_query): SQL 생성
  SELECT 항목명, 당기_반기_누적 
  FROM income_statement 
  WHERE 회사명 = 'SNT다이내믹스' 
    AND (항목명 LIKE '%매출액%' OR 항목명 LIKE '%영업이익%')
  ↓
DB (execute_query): SQL 실행
  Result: 
  - 매출액: 336,666,812,235
  - 영업이익: 47,289,352,211
  ↓
LLM (generate_answer): 답변 생성
  ✅ 질문에 "영업이익률" 포함
  ✅ SQL 결과에 매출액과 영업이익 존재
  → 자동 계산!
  → 영업이익률 = (47,289,352,211 ÷ 336,666,812,235) × 100 = 14.05%
  ↓
Output: 
  "매출액: 336,666,812,235원
   영업이익: 47,289,352,211원
   영업이익률: 14.05% (계산: 47,289,352,211 ÷ 336,666,812,235 × 100)" ✅
```

## 📝 핵심 교훈

1. **재무 비율은 DB에 저장되지 않는다**
   - 매출액, 영업이익, 순이익, 자산, 부채, 자본 등 기본 데이터만 저장
   - 비율은 항상 계산해야 함

2. **LLM은 명시적 지침이 필요하다**
   - 단순히 "계산하세요"가 아닌 구체적인 공식과 예시 제공
   - Bad/Good Examples로 명확히 구분

3. **답변 생성 단계에서 처리**
   - SQL 쿼리 단계: 기본 데이터만 조회
   - 답변 생성 단계: 비율 자동 계산 및 포함

4. **사용자 질문 분석**
   - "영업이익률", "순이익률", "ROE" 등의 키워드 감지
   - SQL 결과에 필요한 데이터가 있는지 확인
   - 조건 충족 시 자동 계산

## 🔗 관련 파일

- `tools.py` - Text2SQL 및 답변 생성 로직
- `재무비율_계산_가이드.md` - SQL JOIN을 통한 비율 계산 (이전 가이드)
- `graph.py` - Iterative RAG에서의 비율 계산 지침

---

**작성일**: 2025-10-01  
**문제**: 영업이익률 계산 실패 ("정보가 제공되지 않았습니다")  
**해결**: `generate_answer` 함수에 자동 계산 로직 추가

