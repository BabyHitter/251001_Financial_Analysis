# 순이익 항목명 차이 해결 가이드

## 🔴 문제 상황

"SK텔레콤, kt, lg유플러스의 매출액, 영업이익, 순이익과 영업이익률, 순이익률을 비교, 분석해줘" 질문 시 **SK텔레콤의 순이익 데이터 조회 실패**

## 🔍 원인 분석

### 데이터베이스 조사 결과

```sql
-- 회사별 순이익 항목명 확인
SELECT DISTINCT 회사명, 항목명 
FROM income_statement 
WHERE 회사명 IN ('SK텔레콤', '케이티', 'LG유플러스') 
  AND 항목명 LIKE '%순이익%' 
ORDER BY 회사명, 항목명;
```

**결과:**
```
✅ LG유플러스: "반기순이익"
✅ 케이티: "반기순이익"
❌ SK텔레콤: "당기순이익" (반기순이익 없음!)
```

### 문제의 근본 원인

**각 회사마다 순이익 항목명이 다릅니다:**

| 회사 | 순이익 항목명 | 비고 |
|------|--------------|------|
| 삼성전자 | 반기순이익 | ✅ |
| SK하이닉스 | 반기순이익 | ✅ |
| 케이티 | 반기순이익 | ✅ |
| LG유플러스 | 반기순이익 | ✅ |
| **SK텔레콤** | **당기순이익** | ⚠️ 특수 케이스! |

## ✅ 해결 방법

### 1. 포괄적인 검색 패턴 사용

**모든 회사를 커버하는 SQL WHERE 절:**

```sql
WHERE (
    항목명 LIKE '%반기순이익%' 
    OR 항목명 LIKE '%당기순이익%' 
    OR 항목명 = '당기순이익'
    OR 항목명 LIKE '%순이익%'
)
```

### 2. `tools.py` 수정 내용

#### Before (문제)
```python
- "순이익", "당기순이익" → Use '반기순이익' or '당기반기순이익'
  - WHERE (항목명 LIKE '%반기순이익%' OR 항목명 LIKE '%순이익%')
```

#### After (해결)
```python
- "순이익", "당기순이익" → **CRITICAL: Company-specific variations!**
  - **케이티, LG유플러스**: "반기순이익"
  - **SK텔레콤**: "당기순이익" (반기순이익 없음!)
  - **삼성전자, SK하이닉스**: "반기순이익"
  - **ALWAYS use ALL patterns to catch all companies**:
    - WHERE (항목명 LIKE '%반기순이익%' 
             OR 항목명 LIKE '%당기순이익%' 
             OR 항목명 = '당기순이익' 
             OR 항목명 LIKE '%순이익%')
  - **NEVER query just '반기순이익' - SK텔레콤 will fail!**
  - **NEVER query just '당기순이익' - 케이티/LG유플러스 will fail!**
```

### 3. `graph.py` 수정 내용

#### Before (문제)
```python
- **순이익**: 현재 반기 데이터이므로 "반기순이익" 사용 (당기순이익 아님!)
- **쿼리 작성 시 반드시 두 가지 패턴 모두 포함:**
  - 순이익: "반기순이익, 순이익 조회"
```

#### After (해결)
```python
- **순이익 - 회사별로 다름! CRITICAL!**:
  - **케이티, LG유플러스, 삼성전자, SK하이닉스**: "반기순이익"
  - **SK텔레콤**: "당기순이익" (반기순이익 없음!)
- **쿼리 작성 시 반드시 모든 패턴 포함 (필수!):**
  - 순이익: "반기순이익, 당기순이익, 순이익" (모두 포함 - SK텔레콤 때문!)
```

### 4. SQL 예제 추가

#### SK텔레콤 순이익 조회
```sql
-- "SK텔레콤 순이익은?" (당기순이익 사용! - 반기순이익 없음)
SELECT 회사명, 항목명, 당기_반기_누적
FROM income_statement
WHERE 회사명 = 'SK텔레콤'
  AND (항목명 LIKE '%반기순이익%' 
       OR 항목명 LIKE '%당기순이익%' 
       OR 항목명 = '당기순이익' 
       OR 항목명 LIKE '%순이익%')
```

#### 통신 3사 비교 분석
```sql
-- 통신 3사 순이익 비교 (모든 패턴 포함)
SELECT 회사명, 항목명, 당기_반기_누적 
FROM income_statement 
WHERE 회사명 IN ('SK텔레콤', '케이티', 'LG유플러스')
  AND (항목명 LIKE '%반기순이익%' 
       OR 항목명 LIKE '%당기순이익%' 
       OR 항목명 = '당기순이익' 
       OR 항목명 LIKE '%순이익%')
  AND 항목명 NOT LIKE '%주당%' 
  AND 항목명 NOT LIKE '%법인세%'
ORDER BY 회사명;
```

**결과:**
```
LG유플러스|반기순이익|379,551,000,000 ✅
SK텔레콤|당기순이익|444,822,000,000 ✅
케이티|반기순이익|1,300,081,000,000 ✅
```

### 5. 순이익률 계산 예제

#### 삼성전자 (반기순이익)
```sql
SELECT 
    i_net.회사명,
    i_net.항목명 as 순이익_항목,
    i_net.당기_반기_누적 as 순이익,
    i_rev.항목명 as 매출_항목,
    i_rev.당기_반기_누적 as 매출,
    ROUND(CAST(REPLACE(i_net.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL), 2) as 순이익률
FROM income_statement i_net
JOIN income_statement i_rev ON i_net.회사명 = i_rev.회사명 
    AND i_net.결산기준일 = i_rev.결산기준일
WHERE i_net.회사명 = '삼성전자'
  AND (i_net.항목명 LIKE '%반기순이익%' 
       OR i_net.항목명 LIKE '%당기순이익%' 
       OR i_net.항목명 LIKE '%순이익%')
  AND (i_rev.항목명 LIKE '%매출액%' 
       OR i_rev.항목명 LIKE '%영업수익%')
LIMIT 1;
```

#### SK텔레콤 (당기순이익 + 영업수익)
```sql
SELECT 
    i_net.회사명,
    i_net.항목명 as 순이익_항목,
    i_net.당기_반기_누적 as 순이익,
    i_rev.항목명 as 매출_항목,
    i_rev.당기_반기_누적 as 영업수익,
    ROUND(CAST(REPLACE(i_net.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL), 2) as 순이익률
FROM income_statement i_net
JOIN income_statement i_rev ON i_net.회사명 = i_rev.회사명 
    AND i_net.결산기준일 = i_rev.결산기준일
WHERE i_net.회사명 = 'SK텔레콤'
  AND (i_net.항목명 LIKE '%반기순이익%' 
       OR i_net.항목명 LIKE '%당기순이익%' 
       OR i_net.항목명 = '당기순이익')
  AND (i_rev.항목명 LIKE '%영업수익%' 
       OR i_rev.항목명 LIKE '%매출액%')
LIMIT 1;
```

## 🎯 LLM 프롬프트 가이드

### ✅ 올바른 쿼리 예시

```
"선택: financial_query | 쿼리: SK텔레콤 영업수익, 영업이익, 순이익"
→ "순이익"으로 검색하면 당기순이익도 포함됨

"선택: financial_query | 쿼리: 케이티 영업수익, 영업이익, 순이익"
→ "순이익"으로 검색하면 반기순이익도 포함됨
```

### ❌ 잘못된 쿼리 예시

```
"선택: financial_query | 쿼리: SK텔레콤 반기순이익"
→ SK텔레콤은 "당기순이익"만 있음! 실패!

"선택: financial_query | 쿼리: 케이티 당기순이익"
→ 케이티는 "반기순이익"만 있음! 실패!
```

## 📊 테스트 결과

### 수정 전 (실패)
```
Query: "SK텔레콤, kt, lg유플러스의 순이익 비교"
Result:
- LG유플러스: 379,551,000,000 ✅
- 케이티: 1,300,081,000,000 ✅
- SK텔레콤: 데이터 없음 ❌
```

### 수정 후 (성공)
```
Query: "SK텔레콤, kt, lg유플러스의 순이익 비교"
Result:
- LG유플러스: 379,551,000,000 ✅
- 케이티: 1,300,081,000,000 ✅
- SK텔레콤: 444,822,000,000 ✅
```

## 📝 핵심 교훈

1. **회사마다 항목명이 다를 수 있다!**
   - 반기보고서 vs 연간보고서
   - 산업별 회계 기준 차이
   - 공시 양식 차이

2. **항상 포괄적인 검색 패턴 사용**
   - LIKE '%반기순이익%'
   - LIKE '%당기순이익%'
   - = '당기순이익' (정확한 매칭도 포함)
   - LIKE '%순이익%' (최후의 안전망)

3. **명시적인 예외 케이스 문서화**
   - SK텔레콤의 당기순이익 사용
   - 프롬프트에 명확히 명시
   - SQL 예제 제공

4. **실제 데이터로 검증**
   - 모든 회사의 항목명 확인
   - SQL 쿼리 테스트
   - 예외 케이스 문서화

## 🔗 관련 파일

- `tools.py` - SQL 프롬프트 및 예제
- `graph.py` - Iterative RAG 프롬프트
- `재무용어_매핑_가이드.md` - 재무 용어 매핑 규칙

---

**작성일**: 2025-10-01  
**문제**: SK텔레콤 순이익 조회 실패  
**해결**: 포괄적 검색 패턴 + 회사별 예외 케이스 명시

