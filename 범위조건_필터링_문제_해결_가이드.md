# 범위 조건 필터링 문제 해결 가이드

## 🔴 문제 상황

**사용자 질문:**
"매출액이 100억 이상 1000억 미만이면서, 영업이익률이 20% 이상인 기업 모두 추출해줘"

**시스템 응답 (문제):**
```
SK스퀘어
매출액: 809,402,000,000원 (= 8,094억) ❌ 1000억 미만 조건 위반!

두나무
매출액: 801,946,292,262원 (= 8,019억) ❌ 1000억 미만 조건 위반!

... (10개만 반환, "모두"라고 했는데도) ❌
```

**실제 조건에 맞는 기업:**
- 총 **68개 기업**이 조건을 만족
- 매출액: 100억(10,000,000,000) 이상 ~ 1000억(100,000,000,000) 미만
- 영업이익률: 20% 이상

**문제점:**
1. ❌ 상한선 조건(1000억 미만)이 무시됨
2. ❌ "모두 추출"이라고 했는데 10개만 반환
3. ❌ 조건을 벗어난 기업 포함 (8,000억대 기업들)

## 🔍 원인 분석

### 문제 1: 범위 조건의 상한선 누락

**잘못된 SQL (추정):**
```sql
WHERE CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL) >= 10000000000  -- 100억 이상만 체크
  -- 1000억 미만 조건이 없음! ❌
```

**결과:**
- 100억 이상인 모든 기업 매칭
- 8,000억대 기업(SK스퀘어, 두나무)도 포함됨

### 문제 2: "모두", "추출" 키워드 미인식

**Before:**
```python
**CRITICAL: LIMIT Rules**
- If user asks for "모두", "전부", "all companies", "모든 회사": Use LIMIT 100
```

"추출"이라는 키워드가 포함되지 않음 → LIMIT 10 적용

## ✅ 해결 방법

### 1. 범위 조건 명확화

#### `tools.py` 프롬프트에 추가
```python
**CRITICAL: Range Conditions (범위 조건)**
When user specifies ranges like "100억 이상 1000억 미만", "X 이상 Y 미만", "X ~ Y":
- ALWAYS use BOTH lower bound (>=) AND upper bound (<)
- Example: "매출액 100억 이상 1000억 미만"
  → `CAST(REPLACE(매출액, ',', '') AS REAL) >= 10000000000`
  → `AND CAST(REPLACE(매출액, ',', '') AS REAL) < 100000000000`
- "이상" = >= (inclusive), "미만" = < (exclusive)
- "초과" = > (exclusive), "이하" = <= (inclusive)
- NEVER forget the upper bound! This is critical for accurate filtering!
```

### 2. LIMIT 규칙 확장

#### Before (문제)
```python
- If user asks for "모두", "전부", "all companies", "모든 회사": Use LIMIT 100
```

#### After (해결)
```python
- If user asks for "모두", "전부", "all companies", "모든 회사", "추출": Use LIMIT 100
```

**효과:**
- "모두 추출", "전부 추출", "모두 조회" 등 모든 변형 인식

### 3. 완전한 SQL 예시 추가

```sql
-- "매출액이 100억 이상 1000억 미만이면서, 영업이익률이 20% 이상인 기업 모두 추출해줘"
SELECT DISTINCT
    i_op.회사명,
    i_rev.당기_반기_누적 as 매출액,
    i_op.당기_반기_누적 as 영업이익,
    ROUND(CAST(REPLACE(i_op.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL), 2) as 영업이익률
FROM income_statement i_op
JOIN income_statement i_rev 
    ON i_op.회사명 = i_rev.회사명 
    AND i_op.결산기준일 = i_rev.결산기준일
WHERE (i_op.항목명 = '영업이익' OR i_op.항목명 = '영업이익(손실)')
  AND (i_rev.항목명 = '매출액' OR i_rev.항목명 = '영업수익')
  AND CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL) >= 10000000000   -- 100억 이상 ✅
  AND CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL) < 100000000000   -- 1000억 미만 ✅
  AND (CAST(REPLACE(i_op.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
       CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL)) >= 20  -- 영업이익률 20%+ ✅
ORDER BY 영업이익률 DESC
LIMIT 100;  -- "모두" 추출이므로 100 ✅
```

## 🧪 검증

### 수정 후 정확한 결과 (68개 기업)

```
LS에코에너지|14,846,306,120원|영업이익률: 262.22% ✅
노루홀딩스|18,144,665,038원|영업이익률: 197.78% ✅
이리츠코크렙|11,437,920,248원|영업이익률: 77.89% ✅
DL에너지|81,069,773,527원|영업이익률: 73.41% ✅
아크로스|49,722,671,845원|영업이익률: 71.14% ✅
제이알글로벌리츠|32,869,758,663원|영업이익률: 69.23% ✅
신한서부티엔디리츠|12,610,289,466원|영업이익률: 69.19% ✅
코람코라이프인프라리츠|17,623,199,454원|영업이익률: 66.06% ✅
롯데리츠|35,203,514,807원|영업이익률: 64.28% ✅
한화리츠|26,009,139,701원|영업이익률: 62.94% ✅
... (총 68개, 모두 100억~1000억 범위 내) ✅
```

**검증:**
```python
# 모든 매출액이 범위 내인지 확인
min_revenue = 14,846,306,120  # 약 148억 ✅
max_revenue = 95,872,555,887  # 약 958억 ✅

100억 <= 모든 매출액 < 1000억 ✅
```

### 제외된 기업 (정상)

```
SK스퀘어|809,402,000,000원 (8,094억) ❌ 제외 (1000억 이상)
두나무|801,946,292,262원 (8,019억) ❌ 제외 (1000억 이상)
```

## 📊 한국어 범위 표현 정리

| 한국어 | SQL 연산자 | 예시 |
|--------|-----------|------|
| 이상 | `>=` | `>= 100억` |
| 초과 | `>` | `> 100억` |
| 미만 | `<` | `< 1000억` |
| 이하 | `<=` | `<= 1000억` |

**범위 조합:**
- "100억 이상 1000억 미만" → `>= 100억 AND < 1000억`
- "100억 초과 1000억 이하" → `> 100억 AND <= 1000억`
- "100억 ~ 1000억" → `>= 100억 AND <= 1000억` (보통 양 끝 포함)

## 🎯 핵심 교훈

### 1. 범위 조건은 항상 상하한 모두 지정
❌ `WHERE 매출액 >= 100억` (상한이 없음!)  
✅ `WHERE 매출액 >= 100억 AND 매출액 < 1000억` (상하한 모두 있음)

### 2. "미만"과 "이하" 구분
- **미만** (`<`): 1000억 미만 = 999억까지 OK, 1000억은 NO
- **이하** (`<=`): 1000억 이하 = 1000억까지 OK

### 3. "모두", "추출" 키워드 인식
- "모두 조회", "전부 추출", "모든 기업" → LIMIT 100
- 명시되지 않으면 → LIMIT 10 (기본값)

### 4. SQL에서 범위 체크는 필수
```sql
-- BAD
WHERE revenue >= 10000000000  -- 상한 없음!

-- GOOD
WHERE revenue >= 10000000000   -- 하한
  AND revenue < 100000000000   -- 상한 (필수!)
```

## 🔗 관련 파일

- `tools.py` - SQL 쿼리 생성 프롬프트
- `영업이익률_필터링_문제_해결_가이드.md` - 영업이익률 필터링 관련

---

**작성일**: 2025-10-01  
**문제**: 범위 조건(예: "100억 이상 1000억 미만")의 상한선이 무시됨  
**해결**: 
1. 범위 조건 명확화 프롬프트 추가
2. LIMIT 규칙에 "추출" 키워드 추가
3. 범위 조건 SQL 예시 추가

