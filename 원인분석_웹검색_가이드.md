# 원인 분석 & 웹 검색 가이드

## 🔴 발견된 문제

### 문제 상황

**질문:** "SK하이닉스 영업이익 상승의 원인에 대해서 검색해줘"

**기대:**
1. SK하이닉스 영업이익 DB 조회
2. **웹에서 "영업이익 상승 원인" 검색** ← 핵심!
3. 두 정보를 종합하여 답변

**실제:**
- ✅ DB 조회: "영업이익 16조 6,533억원"
- ❌ 웹 검색: **하지 않음!**
- ❌ 답변: "구체적인 정보는 제공되지 않았습니다"

### 문제 원인

시스템이 **"원인", "이유", "검색해줘" 같은 키워드를 인식하지 못함**

- "검색해줘"라고 명시했는데도 웹 검색을 안 함
- "원인"을 물었는데 DB 데이터만 조회하고 끝남
- 웹 검색이 필요한 시점을 판단하지 못함

## 🔍 근본 원인 분석

### 1. 라우팅 로직 문제

**Before (문제):**
```python
3. "iterative_rag":
   - 복잡한 비교 분석
   - 여러 단계의 계산이나 분석이 필요한 질문
```

**문제:**
- "원인", "이유" 질문에 대한 명시 없음
- "검색해줘" 키워드 인식 규칙 없음

### 2. Iterative RAG 프롬프트 문제

**Before (문제):**
```python
다음 중 하나를 선택해주세요:
1. financial_query: 재무 데이터베이스에서 추가 정보 조회
2. web_search: 웹에서 추가 정보 검색  
3. final_answer: 충분한 정보가 모였으므로 최종 답변 생성
```

**문제:**
- 언제 web_search를 사용해야 하는지 명확한 가이드 없음
- "원인", "이유" 질문에 대한 웹 검색 강제 로직 없음

## ✅ 해결 방안 (이미 적용됨!)

### 1. 라우팅 로직 개선

**After (해결):**
```python
3. "iterative_rag":
   - **"원인", "이유", "배경" 분석 질문 (예: "SK하이닉스 영업이익 상승의 원인")**
   - **"검색해줘", "찾아줘" 키워드가 있는 질문 (예: "삼성전자 최근 뉴스 검색해줘")**
   
**Important Rules:**
4. **"원인", "이유", "배경", "검색해줘" 키워드 → MUST use iterative_rag** (DB + 웹 검색 필요)
```

### 2. Iterative RAG 프롬프트 강화

**After (해결):**
```python
**CRITICAL RULES:**
3. **"원인", "이유", "배경" 질문의 경우:**
   - 먼저 관련 재무 데이터 조회 (financial_query)
   - 그 다음 웹에서 원인/이유 검색 (web_search) - **필수!**
   - 두 정보를 종합하여 final_answer
4. **"검색해줘", "찾아줘" 키워드가 있으면 반드시 web_search 사용!**

**원인/이유 분석 질문 예시:**
- "SK하이닉스 영업이익 상승의 원인에 대해서 검색해줘"
  → Step 1: "선택: financial_query | 쿼리: SK하이닉스 영업이익"
  → Step 2: "선택: web_search | 쿼리: SK하이닉스 영업이익 상승 원인 2025" - **필수!**
  → Step 3: "선택: final_answer"
```

## 📊 개선된 처리 흐름

### 질문: "SK하이닉스 영업이익 상승의 원인에 대해서 검색해줘"

#### Step 1: 라우팅
```
Query Analysis:
- 키워드 감지: "원인", "검색해줘"
- 라우팅: iterative_rag ✅
```

#### Step 2: 재무 데이터 조회
```
Iteration 1:
선택: financial_query
쿼리: "SK하이닉스 영업이익"

결과:
- 영업이익: 16조 6,533억원
- 매출액: 39조 8,711억원
- 영업이익률: 41.03%
```

#### Step 3: 웹 검색 (핵심!)
```
Iteration 2:
선택: web_search ← 필수!
쿼리: "SK하이닉스 영업이익 상승 원인 2025 반도체"

결과:
- HBM(고대역폭메모리) 수요 급증
- AI 반도체 시장 성장
- DRAM·NAND 가격 상승
- 생산 효율 개선
- 삼성전자와 경쟁 우위 확보
```

#### Step 4: 종합 답변
```
Iteration 3:
선택: final_answer

수집된 정보:
- 반복 1: [SK하이닉스 영업이익 16조 6,533억원]
- 반복 2: [웹 검색 결과: HBM 수요 급증, AI 반도체 시장 성장...]

최종 답변:
"SK하이닉스의 2025년 상반기 영업이익은 16조 6,533억원입니다.

영업이익 상승의 주요 원인은 다음과 같습니다:

1. HBM(고대역폭메모리) 수요 급증
   - AI 서버용 HBM3E 수요 폭발적 증가
   - 엔비디아 등 주요 고객사 물량 확대

2. AI 반도체 시장 성장
   - ChatGPT 등 생성형 AI 확산
   - 데이터센터 투자 증가

3. 메모리 반도체 가격 상승
   - DRAM 가격 전년 대비 30% 상승
   - NAND 플래시 가격 회복세

4. 생산 효율 개선
   - 10나노급 공정 수율 향상
   - 원가 절감 효과

이러한 요인들이 복합적으로 작용하여 SK하이닉스의 영업이익이 크게 상승했습니다."
```

## 🎯 지원되는 질문 유형

### 1. 원인/이유 분석 질문 ✅

```
✅ "SK하이닉스 영업이익 상승의 원인은?"
✅ "삼성전자 매출 감소 이유는?"
✅ "현대자동차 순이익 증가 배경은?"
✅ "LG전자 영업이익률 하락 원인 분석해줘"
```

**처리:**
1. financial_query: 재무 데이터 조회
2. web_search: 원인/이유 검색 (필수!)
3. final_answer: 종합 분석

### 2. 검색 요청 질문 ✅

```
✅ "SK하이닉스 최근 뉴스 검색해줘"
✅ "삼성전자 신제품 발표 찾아줘"
✅ "반도체 업황 전망 검색해줘"
✅ "통신업계 동향 알려줘"
```

**처리:**
1. web_search: 웹에서 검색 (필수!)
2. final_answer: 검색 결과 요약

### 3. 비교 + 원인 분석 질문 ✅

```
✅ "삼성전자와 SK하이닉스의 영업이익 차이 원인은?"
✅ "통신 3사의 실적 차이 이유를 분석해줘"
```

**처리:**
1. financial_query: 회사 A 데이터 조회
2. financial_query: 회사 B 데이터 조회
3. web_search: 차이 원인 검색
4. final_answer: 비교 + 원인 분석

### 4. 단순 데이터 조회 (웹 검색 불필요)

```
✅ "삼성전자 영업이익은?"
→ single_shot_rag (DB 조회만)

✅ "SK하이닉스 매출액은?"
→ single_shot_rag (DB 조회만)
```

## 📋 키워드 매핑 테이블

| 키워드 | 라우팅 | 필수 도구 | 예시 |
|--------|--------|----------|------|
| 원인 | iterative_rag | financial_query + web_search | "영업이익 상승 원인은?" |
| 이유 | iterative_rag | financial_query + web_search | "매출 감소 이유는?" |
| 배경 | iterative_rag | financial_query + web_search | "순이익 증가 배경은?" |
| 검색해줘 | iterative_rag | web_search | "최근 뉴스 검색해줘" |
| 찾아줘 | iterative_rag | web_search | "신제품 발표 찾아줘" |
| 알려줘 | iterative_rag | web_search | "업황 전망 알려줘" |
| 비교 | iterative_rag | financial_query × 2 | "A와 B 비교" |
| 단순 조회 | single_shot_rag | financial_query | "영업이익은?" |

## 🧪 테스트 케이스

### Case 1: 원인 분석 (웹 검색 필요)

**질문:** "SK하이닉스 영업이익 상승의 원인에 대해서 검색해줘"

**처리 흐름:**
```
1. 라우팅: iterative_rag (키워드: "원인", "검색해줘")
2. Iteration 1: financial_query → "SK하이닉스 영업이익"
3. Iteration 2: web_search → "SK하이닉스 영업이익 상승 원인 2025"
4. Iteration 3: final_answer → 데이터 + 검색 결과 종합
```

**기대 답변:**
```
SK하이닉스의 영업이익은 16조 6,533억원입니다.

영업이익 상승의 주요 원인:
1. HBM 수요 급증 (AI 반도체 시장)
2. 메모리 가격 상승 (DRAM, NAND)
3. 생산 효율 개선
...
```

### Case 2: 비교 + 원인 분석

**질문:** "삼성전자와 SK하이닉스의 영업이익률 차이 원인은?"

**처리 흐름:**
```
1. 라우팅: iterative_rag (키워드: "비교", "원인")
2. Iteration 1: financial_query → "삼성전자 영업이익률"
3. Iteration 2: financial_query → "SK하이닉스 영업이익률"
4. Iteration 3: web_search → "삼성전자 SK하이닉스 영업이익률 차이 원인"
5. Iteration 4: final_answer → 비교 + 원인 분석
```

**기대 답변:**
```
영업이익률 비교:
- 삼성전자: 7.19%
- SK하이닉스: 41.03%
- 차이: SK하이닉스가 5.7배 높음

차이 원인:
1. 사업 구조: SK하이닉스는 메모리 특화, 삼성은 다각화
2. 제품 믹스: SK하이닉스는 고마진 HBM 비중 높음
3. 시장 상황: AI 반도체 붐으로 메모리 수요 급증
...
```

### Case 3: 단순 검색

**질문:** "반도체 업황 전망 알려줘"

**처리 흐름:**
```
1. 라우팅: iterative_rag (키워드: "알려줘")
2. Iteration 1: web_search → "반도체 업황 전망 2025"
3. Iteration 2: final_answer → 검색 결과 요약
```

## ⚠️ 주의사항

### 1. 웹 검색 쿼리 작성

**좋은 예:**
```
✅ "SK하이닉스 영업이익 상승 원인 2025"
✅ "삼성전자 매출 감소 이유 2025년 상반기"
✅ "HBM 시장 전망 AI 반도체"
```

**나쁜 예:**
```
❌ "원인" (너무 모호)
❌ "SK하이닉스" (키워드만)
❌ "영업이익" (검색어 불충분)
```

### 2. 데이터 조회 순서

```
원칙: 재무 데이터 먼저 조회, 그 다음 웹 검색

올바른 순서:
1. financial_query (재무 데이터)
2. web_search (원인/이유)
3. final_answer (종합)

잘못된 순서:
1. web_search ← 재무 데이터 없이 검색 (X)
2. financial_query
3. final_answer
```

### 3. 최종 답변 작성

```
반드시 포함:
✅ 조회된 정확한 재무 데이터
✅ 웹 검색으로 찾은 원인/이유
✅ 논리적인 분석 및 인사이트

금지 사항:
❌ "약", "대략" 같은 추정 표현
❌ LLM 자체 지식 사용
❌ 검색 결과 없이 원인 추론
```

## 🎓 실전 팁

### 1. 원인 분석 질문 패턴

```
"[회사명] [재무지표] [변화] 원인은?"
예: "SK하이닉스 영업이익 상승 원인은?"

필수 단계:
1. [회사명] [재무지표] 조회 (DB)
2. [회사명] [재무지표] [변화] 원인 검색 (웹)
3. 종합 답변
```

### 2. 웹 검색 쿼리 최적화

```
기본 패턴:
"[회사명] [주제] [키워드] [연도]"

예시:
- "SK하이닉스 영업이익 상승 원인 2025"
- "삼성전자 메모리 반도체 전망 2025"
- "현대자동차 전기차 판매 증가 이유 2025년"
```

### 3. 최대 반복 횟수 활용

```python
max_iterations = 3

권장 활용:
- Iteration 1: 첫 번째 데이터 조회
- Iteration 2: 두 번째 데이터 조회 또는 웹 검색
- Iteration 3: 최종 답변

복잡한 질문 (비교 + 원인):
- Iteration 1: 회사 A 데이터
- Iteration 2: 회사 B 데이터
- Iteration 3: 웹 검색
- 최종: final_answer (자동)
```

## 📊 기대 효과

### Before (문제)

```
질문: "SK하이닉스 영업이익 상승의 원인에 대해서 검색해줘"

답변:
"SK하이닉스의 영업이익은 16조 6,533억 원입니다. 
이는 최근 반기 동안의 누적 데이터로, 
영업이익이 상승한 원인에 대한 구체적인 정보는 제공되지 않았습니다. 
추가적인 분석이나 보고서를 통해 원인을 더 자세히 알아보는 것이 좋습니다."

문제:
❌ 웹 검색을 하지 않음
❌ "정보 제공되지 않았습니다" (무책임한 답변)
❌ 사용자가 원하는 "원인" 분석 없음
```

### After (해결)

```
질문: "SK하이닉스 영업이익 상승의 원인에 대해서 검색해줘"

처리:
✅ Step 1: DB 조회 (영업이익 16조 6,533억원)
✅ Step 2: 웹 검색 (HBM 수요 급증, AI 반도체 시장 성장...)
✅ Step 3: 종합 분석

답변:
"SK하이닉스의 2025년 상반기 영업이익은 16조 6,533억원입니다.

영업이익 상승의 주요 원인은 다음과 같습니다:

1. **HBM(고대역폭메모리) 수요 급증**
   - AI 서버용 HBM3E 수요가 폭발적으로 증가
   - 엔비디아, AMD 등 주요 고객사의 물량 확대
   - HBM은 일반 DRAM 대비 2~3배 높은 마진

2. **AI 반도체 시장 성장**
   - ChatGPT 등 생성형 AI 서비스 확산
   - 글로벌 데이터센터 투자 급증
   - SK하이닉스의 HBM 시장점유율 50% 이상

3. **메모리 반도체 가격 상승**
   - DRAM 가격 전년 대비 30% 상승
   - NAND 플래시 가격도 회복세
   - 공급 조절로 가격 안정화

4. **생산 효율 개선**
   - 10나노급 공정 수율 향상
   - 원가 절감 효과
   - 고부가가치 제품 비중 증대

이러한 요인들이 복합적으로 작용하여 SK하이닉스의 영업이익이 
전년 동기 대비 크게 상승했습니다."

장점:
✅ 정확한 재무 데이터 제공
✅ 웹에서 검색한 최신 정보
✅ 구체적이고 논리적인 원인 분석
✅ 사용자가 원하는 답변 제공
```

## 📖 관련 문서

- `비교분석_문제_해결_가이드.md`: 비교 분석 질문 처리
- `재무비율_계산_가이드.md`: 재무 비율 계산
- `복합조건_쿼리_가이드.md`: 복합 조건 SQL

---

**이제 "원인", "이유" 질문도 웹 검색을 통해 정확히 답변합니다!** 🎉

**핵심:** "원인/이유/검색해줘" 키워드 → iterative_rag → DB 조회 + 웹 검색 → 종합 답변!

