# 재무비율 계산 가이드

## 🎯 문제 해결: DB에 없는 재무비율 계산

### 핵심 이슈

**데이터베이스 현황:**
- ✅ 매출액, 영업이익, 자산, 부채 등 **원시 데이터**는 있음
- ❌ 영업이익률, ROE, 부채비율 등 **비율 데이터**는 없음

**사용자 질문:**
- "삼성전자 영업이익률은?" ← 계산 필요!
- "케이티 부채비율은?" ← 계산 필요!
- "SK텔레콤 ROE는?" ← 계산 필요!

### 해결 방법: SQL JOIN으로 직접 계산

## 📊 주요 재무비율 정의

### 1. 영업이익률 (Operating Profit Margin)

**공식:**
```
영업이익률 = (영업이익 / 매출액) × 100
```

**SQL 쿼리:**
```sql
SELECT 
    i_op.회사명,
    i_op.당기_반기_누적 as 영업이익,
    i_rev.당기_반기_누적 as 매출액,
    ROUND(i_op.당기_반기_누적 * 100.0 / i_rev.당기_반기_누적, 2) as 영업이익률
FROM income_statement i_op
JOIN income_statement i_rev ON i_op.회사명 = i_rev.회사명 
    AND i_op.결산기준일 = i_rev.결산기준일
WHERE i_op.회사명 = '삼성전자'
  AND i_op.항목명 LIKE '%영업이익%'
  AND (i_rev.항목명 LIKE '%매출액%' OR i_rev.항목명 LIKE 'I. 매출%')
LIMIT 1;
```

**실제 결과 (삼성전자):**
```
영업이익: 11,361,329,000,000원 (11조 3,613억원)
매출액: 153,706,820,000,000원 (153조 7,068억원)
영업이익률: 7.19%
```

### 2. 순이익률 (Net Profit Margin)

**공식:**
```
순이익률 = (반기순이익 / 매출액) × 100
```

**주의사항:**
- "당기순이익"이 아니라 "반기순이익" 항목명 사용!

**SQL 쿼리:**
```sql
SELECT 
    i_net.회사명,
    i_net.당기_반기_누적 as 반기순이익,
    i_rev.당기_반기_누적 as 매출액,
    ROUND(i_net.당기_반기_누적 * 100.0 / i_rev.당기_반기_누적, 2) as 순이익률
FROM income_statement i_net
JOIN income_statement i_rev ON i_net.회사명 = i_rev.회사명 
    AND i_net.결산기준일 = i_rev.결산기준일
WHERE i_net.회사명 = '삼성전자'
  AND i_net.항목명 = '반기순이익'
  AND (i_rev.항목명 LIKE '%매출액%' OR i_rev.항목명 LIKE 'I. 매출%')
LIMIT 1;
```

### 3. ROE (Return on Equity) / 자기자본이익률

**공식:**
```
ROE = (반기순이익 / 자본총계) × 100
```

**특징:**
- income_statement와 balance_sheet를 JOIN
- 상반기 기준이므로 연간 ROE는 약 2배

**SQL 쿼리:**
```sql
SELECT 
    i.회사명,
    i.당기_반기_누적 as 반기순이익,
    b.당기_반기말 as 자본총계,
    ROUND(i.당기_반기_누적 * 100.0 / b.당기_반기말, 2) as ROE_반기
FROM income_statement i
JOIN balance_sheet b ON i.회사명 = b.회사명 
    AND i.결산기준일 = b.결산기준일
WHERE i.회사명 = '삼성전자'
  AND i.항목명 = '반기순이익'
  AND b.항목명 = '자본총계'
LIMIT 1;
```

**실제 결과 (삼성전자):**
```
반기순이익: 13,339,313,000,000원 (13조 3,393억원)
자본총계: 399,561,967,000,000원 (399조 5,619억원)
ROE (반기): 3.26%
ROE (연간 추정): 약 6.5%
```

### 4. ROA (Return on Assets) / 총자산이익률

**공식:**
```
ROA = (반기순이익 / 자산총계) × 100
```

**SQL 쿼리:**
```sql
SELECT 
    i.회사명,
    i.당기_반기_누적 as 반기순이익,
    b.당기_반기말 as 자산총계,
    ROUND(i.당기_반기_누적 * 100.0 / b.당기_반기말, 2) as ROA_반기
FROM income_statement i
JOIN balance_sheet b ON i.회사명 = b.회사명 
    AND i.결산기준일 = b.결산기준일
WHERE i.회사명 = '삼성전자'
  AND i.항목명 = '반기순이익'
  AND b.항목명 LIKE '%자산총계%'
LIMIT 1;
```

### 5. 부채비율 (Debt Ratio)

**공식:**
```
부채비율 = (부채총계 / 자본총계) × 100
```

**특징:**
- balance_sheet 테이블만 사용
- 낮을수록 재무 건전성 양호

**SQL 쿼리:**
```sql
SELECT 
    b_debt.회사명,
    b_debt.당기_반기말 as 부채총계,
    b_equity.당기_반기말 as 자본총계,
    ROUND(b_debt.당기_반기말 * 100.0 / b_equity.당기_반기말, 2) as 부채비율
FROM balance_sheet b_debt
JOIN balance_sheet b_equity ON b_debt.회사명 = b_equity.회사명
    AND b_debt.결산기준일 = b_equity.결산기준일
WHERE b_debt.회사명 = '삼성전자'
  AND b_debt.항목명 = '부채총계'
  AND b_equity.항목명 = '자본총계'
LIMIT 1;
```

**실제 결과 (삼성전자):**
```
부채총계: 105,313,218,000,000원 (105조 3,132억원)
자본총계: 399,561,967,000,000원 (399조 5,619억원)
부채비율: 26.32%
```

## 🔍 재무비율 요약표

| 비율 | 공식 | 삼성전자 실제값 | 의미 |
|------|------|----------------|------|
| 영업이익률 | 영업이익/매출액×100 | 7.19% | 매출 대비 영업이익 |
| 순이익률 | 순이익/매출액×100 | 계산 가능 | 매출 대비 순이익 |
| ROE | 순이익/자본×100 | 3.26% (반기) | 자본 수익률 |
| ROA | 순이익/자산×100 | 계산 가능 | 자산 수익률 |
| 부채비율 | 부채/자본×100 | 26.32% | 재무 안정성 |

## 💡 프롬프트 가이드라인

### LLM에게 제공하는 지침

```
## CRITICAL: Financial Ratio Calculation

데이터베이스에는 비율 컬럼이 없습니다. 반드시 SQL로 계산하세요!

1. 영업이익률: JOIN으로 영업이익과 매출액 동시 조회
2. ROE: income_statement + balance_sheet JOIN
3. 부채비율: balance_sheet 내에서 JOIN

항상 다음을 표시:
- 원시 데이터 (예: 영업이익 11조원, 매출액 153조원)
- 계산된 비율 (예: 영업이익률 7.19%)
- 공식 설명 (예: 영업이익 ÷ 매출액 × 100)
```

## 🧪 테스트 예시

### Case 1: 영업이익률 질문

**질문:** "삼성전자 영업이익률은?"

**생성 SQL:**
```sql
SELECT 
    i_op.회사명,
    i_op.당기_반기_누적 as 영업이익,
    i_rev.당기_반기_누적 as 매출액,
    ROUND(i_op.당기_반기_누적 * 100.0 / i_rev.당기_반기_누적, 2) as 영업이익률
FROM income_statement i_op
JOIN income_statement i_rev ON i_op.회사명 = i_rev.회사명
WHERE i_op.회사명 = '삼성전자'
  AND i_op.항목명 LIKE '%영업이익%'
  AND i_rev.항목명 LIKE '%매출액%'
```

**기대 답변:**
```
삼성전자의 2025년 상반기 영업이익률은 7.19%입니다.

계산 근거:
- 영업이익: 11조 3,613억원
- 매출액: 153조 7,068억원
- 영업이익률 = (11조 ÷ 153조) × 100 = 7.19%
```

### Case 2: 부채비율 질문

**질문:** "케이티 부채비율은?"

**생성 SQL:**
```sql
SELECT 
    b_debt.회사명,
    b_debt.당기_반기말 as 부채총계,
    b_equity.당기_반기말 as 자본총계,
    ROUND(b_debt.당기_반기말 * 100.0 / b_equity.당기_반기말, 2) as 부채비율
FROM balance_sheet b_debt
JOIN balance_sheet b_equity ON b_debt.회사명 = b_equity.회사명
WHERE b_debt.회사명 = '케이티'
  AND b_debt.항목명 = '부채총계'
  AND b_equity.항목명 = '자본총계'
```

### Case 3: ROE 질문

**질문:** "SK텔레콤 ROE는?"

**생성 SQL:**
```sql
SELECT 
    i.회사명,
    i.당기_반기_누적 as 반기순이익,
    b.당기_반기말 as 자본총계,
    ROUND(i.당기_반기_누적 * 100.0 / b.당기_반기말, 2) as ROE
FROM income_statement i
JOIN balance_sheet b ON i.회사명 = b.회사명
WHERE i.회사명 = 'SK텔레콤'
  AND i.항목명 = '반기순이익'
  AND b.항목명 = '자본총계'
```

## ⚠️ 주의사항

### 1. 항목명 정확히 매칭

```
✅ "반기순이익" (O)
❌ "당기순이익" (X - 이 항목명은 없음!)

✅ "영업이익" (O)
❌ "영업이익(손실)" (LIKE로 자동 포함됨)
```

### 2. JOIN 조건 필수

```sql
-- ✅ 올바름: 회사명과 결산기준일 모두 매칭
JOIN income_statement i_rev 
  ON i_op.회사명 = i_rev.회사명 
  AND i_op.결산기준일 = i_rev.결산기준일

-- ❌ 잘못됨: 결산기준일 누락
JOIN income_statement i_rev 
  ON i_op.회사명 = i_rev.회사명
```

### 3. 테이블 별칭 사용

```sql
-- ✅ 명확한 별칭
FROM income_statement i_op      -- 영업이익
JOIN income_statement i_rev     -- 매출액

-- ✅ 명확한 별칭
FROM balance_sheet b_debt       -- 부채
JOIN balance_sheet b_equity     -- 자본
```

### 4. 반기 vs 연간 주의

```
반기 ROE 3.26% → 연간 추정 약 6.5%
(단순 2배가 아닐 수 있음, 참고용)
```

## 📈 확장 가능한 비율

### 추가 구현 가능한 비율

```
매출총이익률 = (매출총이익 / 매출액) × 100
유동비율 = (유동자산 / 유동부채) × 100
당좌비율 = (당좌자산 / 유동부채) × 100
자기자본비율 = (자본 / 자산) × 100
```

## 🎯 사용자 경험

### Before (구현 전)
```
질문: "삼성전자 영업이익률은?"
답변: "죄송합니다. 영업이익률 데이터를 찾을 수 없습니다."
```

### After (구현 후)
```
질문: "삼성전자 영업이익률은?"
답변: "삼성전자의 2025년 상반기 영업이익률은 7.19%입니다.

상세:
- 영업이익: 11조 3,613억원
- 매출액: 153조 7,068억원
- 계산식: (11조 3,613억 ÷ 153조 7,068억) × 100 = 7.19%"
```

## 🔧 구현 요약

1. **프롬프트에 재무비율 계산 가이드 추가**
   - 각 비율의 공식 명시
   - SQL JOIN 예시 제공
   - 항목명 매핑 규칙

2. **SQL JOIN 활용**
   - 같은 테이블 JOIN (영업이익률, 순이익률)
   - 다른 테이블 JOIN (ROE, ROA)

3. **결과 포맷팅**
   - 원시 데이터 + 계산 비율
   - 공식 설명 포함
   - 이해하기 쉬운 표현

---

**이제 DB에 없는 재무비율도 실시간으로 계산하여 제공합니다!** 🎉

