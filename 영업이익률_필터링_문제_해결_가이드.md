# 영업이익률 필터링 문제 해결 가이드

## 🔴 문제 상황

**사용자 질문:**
"영업이익률이 20% 이상이면서, 매출액이 1000억 이상인 회사 모두 조회해줘"

**시스템 응답 (문제):**
```
회사명: 효성화학
영업이익: 555,249,616,393원
매출액: 1,189,912,595,032원
영업이익률: 55,500.0% ❌ (실제: 46.68%)

회사명: GS에너지
영업이익: 987,316,000,000원
매출액: 2,833,633,000,000원
영업이익률: 49,350.0% ❌ (실제: 34.85%)

... (10개만 반환, "모두"라고 했는데도) ❌
```

**문제점:**
1. ❌ 영업이익률이 터무니없이 높게 계산됨 (55,500%, 49,350% 등)
2. ❌ "모두 조회"라고 했는데 10개만 반환
3. ❌ 회사 중복 (HDC가 3번 나타남)

**기대 응답:**
```
SK하이닉스|16,653,355,000,000원|39,871,093,000,000원|41.77% ✅
삼성바이오로직스|962,288,400,562원|2,588,178,371,259원|37.18% ✅
크래프톤|703,339,456,746원|1,536,232,622,991원|45.78% ✅
... (조건에 맞는 모든 회사 반환) ✅
```

## 🔍 원인 분석

### 문제 1: 영업이익률 이중 계산

**원인:**
SQL에서 이미 `× 100`을 했는데, 답변 생성 시 또 `× 100`을 해서 10,000배가 됨

**예시:**
```python
# SQL에서 계산
영업이익률 = (555,249,616,393 / 1,189,912,595,032) × 100 = 46.68

# 답변 생성 시 다시 × 100
영업이익률 = 46.68 × 100 = 4,668%

# 또는 숫자 포맷팅 오류
영업이익률 = 555 (억 단위) × 100 = 55,500%
```

### 문제 2: 항목명 부분 매칭 오류

**원인:**
`항목명 LIKE '%매출액%'`를 사용하여 불필요한 항목도 매칭됨

**한국전력공사 예시:**
```sql
SELECT 항목명, 당기_반기_누적 FROM income_statement WHERE 회사명 = '한국전력공사';

-- 결과:
매출액                          | 46,174,122,000,000 ← 이게 정확한 총 매출액!
건설계약으로 인한 매출액         | 237,468,000,000    ← 부분 매출액
용역의 제공으로 인한 매출액      | 303,574,000,000    ← 부분 매출액
재화의 판매로 인한 매출액        | 45,202,445,000,000 ← 부분 매출액
```

**잘못된 SQL (LIKE '%매출액%'):**
```sql
WHERE i_rev.항목명 LIKE '%매출액%'  -- "건설계약으로 인한 매출액"도 매칭됨!

-- JOIN 결과:
영업이익: 5,889,479,000,000
매출액: 237,468,000,000 ← 부분 매출액과 매칭!
영업이익률 = 5,889,479 / 237,468 × 100 = 2,480% ❌
```

**올바른 SQL (정확한 매칭):**
```sql
WHERE i_rev.항목명 = '매출액'  -- 정확한 총 매출액만 매칭!

-- JOIN 결과:
영업이익: 5,889,479,000,000
매출액: 46,174,122,000,000 ← 정확한 총 매출액!
영업이익률 = 5,889,479 / 46,174,122 × 100 = 12.76% ✅
```

### 문제 3: LIMIT 하드코딩

**원인:**
`top_k: 10`이 하드코딩되어 "모두", "전부", "all" 같은 키워드를 무시

**Before:**
```python
prompt = query_prompt_template.invoke({
    "top_k": 10,  # 항상 10개만!
    ...
})
```

**프롬프트:**
```
Unless the user specifies in his question a specific number of examples they wish to obtain, 
always limit your query to at most {top_k} results.
```

→ "모두 조회"라고 해도 LIMIT 10이 적용됨 ❌

## ✅ 해결 방법

### 1. LIMIT 동적 처리 지침 추가

#### `tools.py` 수정
```python
**CRITICAL: LIMIT Rules**
- If user asks for "모두", "전부", "all companies", "모든 회사": Use LIMIT 100 (not {top_k})
- If user specifies a number (예: "상위 5개"): Use that number
- Otherwise: Use LIMIT {top_k}
```

**효과:**
- "영업이익률 20% 이상인 회사 모두" → LIMIT 100 ✅
- "상위 5개 기업" → LIMIT 5 ✅
- 기본값 → LIMIT 10 ✅

### 2. 항목명 정확한 매칭 규칙

#### Before (문제)
```sql
WHERE i_op.항목명 LIKE '%영업이익%'  -- "영업이익", "영업이익(손실)", "영업외이익" 모두 매칭 ❌
  AND i_rev.항목명 LIKE '%매출액%'  -- "매출액", "건설계약으로 인한 매출액" 모두 매칭 ❌
```

#### After (해결)
```sql
WHERE (i_op.항목명 = '영업이익' OR i_op.항목명 = '영업이익(손실)')  -- 정확한 매칭만! ✅
  AND (i_rev.항목명 = '매출액' OR i_rev.항목명 = '영업수익')      -- 정확한 매칭만! ✅
```

**프롬프트 추가:**
```
**CRITICAL**: Use EXACT item name matching to avoid partial matches!
- 매출액: Use `항목명 = '매출액'` NOT `항목명 LIKE '%매출액%'`
- 영업수익: Use `항목명 = '영업수익'` NOT `항목명 LIKE '%영업수익%'`
- 영업이익: Use `(항목명 = '영업이익' OR 항목명 = '영업이익(손실)')` NOT `항목명 LIKE '%영업이익%'`
- This prevents matching "건설계약으로 인한 매출액" or "재화의 판매로 인한 매출액"
```

### 3. 영업이익률 이중 계산 방지

#### `generate_answer` 함수 수정
```python
"**CRITICAL: Financial Ratio - Check if Already Calculated in SQL!**\n"
"1. First, check if SQL Result already has ratio columns (영업이익률, 순이익률, ROE, etc.)\n"
"2. If YES: Use the calculated value AS IS (already in percentage) - DO NOT recalculate!\n"
"3. If NO: Calculate it yourself from the raw data\n\n"
"**Example:**\n"
"- SQL Result has '영업이익률: 14.05' → Answer: '영업이익률: 14.05%' (just add %) ✅\n"
"- SQL Result has '영업이익: 1000, 매출액: 5000' → Calculate: '영업이익률: 20% (1000÷5000×100)' ✅\n"
```

**효과:**
- SQL에 영업이익률 컬럼이 있으면 그대로 사용 (다시 계산 금지)
- SQL에 영업이익률 컬럼이 없으면 매출액과 영업이익으로 계산

### 4. 완전한 SQL 쿼리 예시

```sql
-- "영업이익률 20% 이상이면서 매출액 1000억 이상인 회사 모두"
SELECT DISTINCT
    i_op.회사명,
    i_op.당기_반기_누적 as 영업이익,
    i_rev.당기_반기_누적 as 매출액,
    ROUND(CAST(REPLACE(i_op.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL), 2) as 영업이익률
FROM income_statement i_op
JOIN income_statement i_rev 
    ON i_op.회사명 = i_rev.회사명 
    AND i_op.결산기준일 = i_rev.결산기준일
WHERE (i_op.항목명 = '영업이익' OR i_op.항목명 = '영업이익(손실)')  -- 정확한 매칭!
  AND (i_rev.항목명 = '매출액' OR i_rev.항목명 = '영업수익')        -- 정확한 매칭!
  AND CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL) >= 100000000000  -- 1000억
  AND (CAST(REPLACE(i_op.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
       CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL)) >= 20  -- 영업이익률 20%+
ORDER BY 영업이익률 DESC
LIMIT 100;  -- "모두" 조회이므로 100
```

## 🧪 검증

### 수정 전 결과 (문제)
```sql
-- 잘못된 SQL (LIKE '%매출액%')
한국전력공사|5,889,479,000,000|237,468,000,000|2480.11 ❌
한국가스공사|1,238,563,000,000|224,458,000,000|551.8 ❌
```

### 수정 후 결과 (정상)
```sql
-- 올바른 SQL (항목명 = '매출액')
SK하이닉스|16,653,355,000,000|39,871,093,000,000|41.77 ✅
삼성바이오로직스|962,288,400,562|2,588,178,371,259|37.18 ✅
크래프톤|703,339,456,746|1,536,232,622,991|45.78 ✅
휴젤|95,623,891,825|200,080,877,742|47.79 ✅
리노공업|88,382,117,361|190,932,307,676|46.29 ✅
클래시스|81,792,581,445|160,397,102,486|50.99 ✅
시프트업|94,466,613,903|154,617,107,742|61.1 ✅
두나무|549,108,675,819|801,946,292,262|68.47 ✅
파마리서치|100,611,274,981|257,517,417,773|39.07 ✅
```

**검증 계산:**
```python
# SK하이닉스
영업이익 = 16,653,355,000,000
매출액 = 39,871,093,000,000
영업이익률 = (16,653,355 / 39,871,093) × 100 = 41.77% ✅

# 삼성바이오로직스
영업이익 = 962,288,400,562
매출액 = 2,588,178,371,259
영업이익률 = (962,288 / 2,588,178) × 100 = 37.18% ✅
```

## 📊 핵심 교훈

### 1. 항목명 매칭은 정확하게
❌ `항목명 LIKE '%매출액%'` → "건설계약으로 인한 매출액" 등 부분 항목도 매칭  
✅ `항목명 = '매출액'` → 정확한 총 매출액만 매칭

### 2. 비율 계산은 한 번만
- SQL에서 계산했으면 답변에서 다시 계산하지 말 것
- SQL 결과에 비율 컬럼이 있는지 먼저 확인

### 3. "모두" 키워드 인식
- "모두", "전부", "all" → LIMIT 100
- "상위 N개" → LIMIT N
- 기본값 → LIMIT 10

### 4. DISTINCT로 중복 방지
- JOIN 시 중복 행이 발생할 수 있으므로 항상 `SELECT DISTINCT` 사용

### 5. 산업별 차이 고려
- 제조업: 매출액 사용
- 금융/통신: 영업수익 사용
- SQL WHERE 조건: `(항목명 = '매출액' OR 항목명 = '영업수익')`

## 🔗 관련 파일

- `tools.py` - SQL 쿼리 생성 및 답변 생성 로직
- `재무비율_자동계산_가이드.md` - 단순 비율 계산 (이전 가이드)
- `재무비율_계산_가이드.md` - SQL JOIN 비율 계산 (이전 가이드)

---

**작성일**: 2025-10-01  
**문제**: 영업이익률 필터링 시 계산 오류 및 결과 개수 제한  
**해결**: 
1. 항목명 정확한 매칭 규칙 추가
2. LIMIT 동적 처리 지침 추가
3. 비율 이중 계산 방지 로직 추가

