# 비교 분석 문제 해결 가이드

## 🔴 발견된 심각한 문제

### 문제 상황

**질문:** "삼성전자와 sk하이닉스의 매출액, 영업이익, 순이익 및 영업이익률과 순이익률 비교 분석해줘"

**기대:** DB에서 정확한 데이터 조회

**실제:** LLM이 자체 지식으로 부정확한 추정치 제공 ❌

### 잘못된 답변 예시

```
삼성전자 재무 정보 (2023년 상반기 기준)
- 매출액: 약 60조 원  ← 실제: 153조 7,068억원 (2배 이상 차이!)
- 영업이익: 약 10조 원  ← 실제: 11조 3,613억원
- 순이익: 약 8조 원  ← 실제: 13조 3,393억원 (1.6배 차이!)
```

**심각도:** 🔴 **매우 심각** - 사용자에게 완전히 잘못된 정보 제공

## 🔍 근본 원인 분석

### 1. Iterative RAG 로직 문제

#### 문제점

```python
# graph.py의 iterative_rag_node
analysis_prompt = f"""
다음 중 하나를 선택해주세요:
1. "financial_query": 재무 데이터베이스에서 추가 정보 조회
2. "web_search": 웹에서 추가 정보 검색  
3. "final_answer": 충분한 정보가 모였으므로 최종 답변 생성
"""
```

**문제:**
- LLM이 데이터 조회 없이 바로 "final_answer" 선택 가능
- 재무 데이터 조회 강제 로직 없음
- "비교 분석" 질문에 대한 명확한 가이드 부족

### 2. 최종 답변 생성 문제

#### 문제점

```python
def _generate_final_answer_from_results(self, state):
    intermediate_results = state.get("intermediate_results", [])
    
    final_prompt = f"""
    수집된 정보:
    {chr(10).join(intermediate_results)}
    
    답변을 제공해주세요...
    """
```

**문제:**
- `intermediate_results`가 **비어있어도** 답변 생성
- LLM 자체 지식 사용 금지 규칙 없음
- "약", "추정" 같은 표현 제한 없음

### 3. 대화 흐름 분석

| 순서 | 질문 | 처리 | 결과 |
|-----|------|------|------|
| 1 | "삼성전자 상반기 영업이익은?" | ✅ DB 조회 | 11조 3,613억 (정확) |
| 2 | "sk텔레콤 당기순이익은?" | ✅ DB 조회 | 4,448억 2,200만 (정확) |
| 3 | "sk하이닉스의 영업이익률은?" | ✅ DB 조회 | 41.03% (정확) |
| 4 | "삼성전자와 sk하이닉스 비교 분석" | ❌ LLM 추정 | "약 60조" (부정확!) |

**발견:**
- 단일 회사 질문: 정상 작동 ✅
- **비교 분석 질문: 실패** ❌

## ✅ 해결 방안

### 1. Iterative RAG 프롬프트 강화

**Before (문제):**
```python
다음 중 하나를 선택해주세요:
1. "financial_query": 재무 데이터베이스에서 추가 정보 조회
2. "web_search": 웹에서 추가 정보 검색  
3. "final_answer": 충분한 정보가 모였으므로 최종 답변 생성
```

**After (해결):**
```python
**CRITICAL RULES:**
1. 재무 데이터(매출액, 영업이익, 순이익, 자산 등) 관련 질문은 **반드시 먼저 financial_query로 DB 조회**
2. "비교 분석" 질문의 경우:
   - 첫 번째 회사 데이터 조회 (financial_query)
   - 두 번째 회사 데이터 조회 (financial_query)
   - 모든 데이터가 수집되면 final_answer
3. **절대로 LLM의 자체 지식으로 재무 데이터를 추정하지 마세요!**
4. intermediate_results가 비어있으면 final_answer 선택 금지!

**비교 분석 질문 예시:**
- "삼성전자와 SK하이닉스 비교" 
  → Step 1: "선택: financial_query | 쿼리: 삼성전자 매출액, 영업이익, 순이익, 영업이익률, 순이익률"
  → Step 2: "선택: financial_query | 쿼리: SK하이닉스 매출액, 영업이익, 순이익, 영업이익률, 순이익률"
  → Step 3: "선택: final_answer"
```

### 2. 최종 답변 생성 개선

**Before (문제):**
```python
def _generate_final_answer_from_results(self, state):
    intermediate_results = state.get("intermediate_results", [])
    
    final_prompt = f"""
    수집된 정보:
    {chr(10).join(intermediate_results)}
    
    답변을 제공해주세요...
    """
```

**After (해결):**
```python
def _generate_final_answer_from_results(self, state):
    intermediate_results = state.get("intermediate_results", [])
    
    # 재무 데이터 관련 질문인데 결과가 없으면 경고
    if not intermediate_results:
        return {
            **state,
            "response": "죄송합니다. 재무 데이터를 조회하지 못했습니다. 다시 질문해주시면 데이터베이스에서 정확한 정보를 조회하여 답변드리겠습니다.",
            "route_decision": "error_no_data"
        }
    
    final_prompt = f"""
    **CRITICAL: 답변 규칙**
    - **반드시 수집된 정보만 사용하세요!**
    - **절대로 LLM의 자체 지식이나 추정치를 사용하지 마세요!**
    - 수집된 정보에 없는 데이터는 "데이터 없음"으로 표시
    - "약", "대략", "추정" 같은 표현 금지 (정확한 숫자만 사용)
    - 비교 분석 시 반드시 실제 조회된 데이터 기반으로만 작성
    """
```

### 3. 라우팅 로직 개선

**Before (문제):**
```python
2. "single_shot_rag":
   - 특정 회사의 특정 재무 데이터 조회
   
3. "iterative_rag":
   - 복잡한 비교 분석
```

**After (해결):**
```python
2. "single_shot_rag":
   - 특정 회사의 특정 재무 데이터 조회
   - **복합 조건이지만 SQL JOIN으로 한 번에 처리 가능**
   
3. "iterative_rag":
   - **복잡한 비교 분석 (예: "삼성전자와 SK하이닉스 매출 비교하고 그 차이 원인 분석")**
   - **여러 회사의 재무 데이터를 비교하는 질문**
   
**Important Rules:**
1. Multiple conditions can often be handled by single_shot_rag
2. **"비교", "비교 분석", "compare" 키워드 + 2개 이상 회사명 → MUST use iterative_rag**
3. **"A와 B의 X, Y, Z 비교" → MUST use iterative_rag** (여러 지표 비교)
```

## 🎯 개선된 처리 흐름

### 질문: "삼성전자와 SK하이닉스의 매출액, 영업이익, 순이익 비교"

#### Step 1: 라우팅
```
Query Analysis → "iterative_rag" 
이유: "비교" 키워드 + 2개 회사명 + 여러 지표
```

#### Step 2: 첫 번째 데이터 조회
```
Iteration 1:
선택: financial_query
쿼리: "삼성전자 매출액, 영업이익, 순이익, 영업이익률, 순이익률"

결과:
- 매출액: 153,706,820,000,000원
- 영업이익: 11,361,329,000,000원
- 반기순이익: 13,339,313,000,000원
- 영업이익률: 7.19%
```

#### Step 3: 두 번째 데이터 조회
```
Iteration 2:
선택: financial_query
쿼리: "SK하이닉스 매출액, 영업이익, 순이익, 영업이익률, 순이익률"

결과:
- 매출액: 39,871,140,000,000원
- 영업이익: 16,653,355,000,000원
- 반기순이익: 13,139,625,000,000원
- 영업이익률: 41.03%
```

#### Step 4: 최종 답변 생성
```
Iteration 3:
선택: final_answer

수집된 정보:
- 반복 1: [삼성전자 재무 데이터]
- 반복 2: [SK하이닉스 재무 데이터]

→ **오직 수집된 데이터만 사용하여 비교 분석**
→ "약", "추정" 같은 표현 절대 금지
→ 정확한 숫자와 계산된 비율만 표시
```

## 📊 기대 결과

### Before (문제 있던 답변)

```
삼성전자 재무 정보 (2023년 상반기 기준)
매출액: 약 60조 원  ← 실제: 153조 (2배 이상 오차!)
영업이익: 약 10조 원
순이익: 약 8조 원
영업이익률: 약 16.67%
순이익률: 약 13.33%
```

### After (개선된 답변)

```
삼성전자와 SK하이닉스의 2025년 상반기 재무 비교 분석

1. 매출액
   - 삼성전자: 153조 7,068억원
   - SK하이닉스: 39조 8,711억원
   - 차이: 삼성전자가 약 3.86배 높음

2. 영업이익
   - 삼성전자: 11조 3,613억원
   - SK하이닉스: 16조 6,533억원
   - 차이: SK하이닉스가 약 1.47배 높음

3. 반기순이익
   - 삼성전자: 13조 3,393억원
   - SK하이닉스: 13조 1,396억원
   - 차이: 거의 동등 (삼성전자가 약간 높음)

4. 영업이익률
   - 삼성전자: 7.19%
   - SK하이닉스: 41.03%
   - 차이: SK하이닉스가 압도적으로 높음 (5.7배)

5. 종합 분석
   - 매출 규모: 삼성전자 우위 (다양한 사업 포트폴리오)
   - 수익성: SK하이닉스 우위 (메모리 반도체 특화, 높은 이익률)
   - 절대 이익: 순이익은 거의 동등, 영업이익은 SK하이닉스가 높음
```

**모든 숫자가 DB에서 조회한 정확한 값!** ✅

## 🧪 테스트 케이스

### Case 1: 단일 회사 질문 (정상 작동)

```
✅ "삼성전자 영업이익은?"
→ single_shot_rag → DB 조회 → 정확한 답변

✅ "SK하이닉스 매출액은?"
→ single_shot_rag → DB 조회 → 정확한 답변
```

### Case 2: 비교 질문 (개선됨)

```
✅ "삼성전자와 SK하이닉스 비교"
→ iterative_rag 
→ Step 1: 삼성전자 데이터 조회
→ Step 2: SK하이닉스 데이터 조회
→ Step 3: 비교 분석 (조회된 데이터만 사용)

✅ "통신 3사 재무 비교"
→ iterative_rag
→ Step 1: 케이티 데이터 조회
→ Step 2: SK텔레콤 데이터 조회
→ Step 3: LG유플러스 데이터 조회
→ Step 4: 비교 분석
```

### Case 3: 복합 분석 (개선됨)

```
✅ "삼성전자와 SK하이닉스의 영업이익률을 비교하고 그 차이의 원인 분석해줘"
→ iterative_rag
→ Step 1: 두 회사 재무 데이터 조회
→ Step 2: 비율 계산
→ Step 3: 산업 동향 웹 검색 (필요 시)
→ Step 4: 원인 분석 및 인사이트
```

## ⚠️ 핵심 원칙

### 1. 데이터 조회 강제

```
재무 데이터 관련 질문 = 반드시 DB 조회!
LLM 자체 지식 사용 = 절대 금지!
```

### 2. 비교 분석 처리

```
"비교" 키워드 + 2개 이상 회사 = iterative_rag
각 회사별로 순차적 데이터 조회
모든 데이터 수집 후 비교 분석
```

### 3. 답변 정확성

```
"약", "대략", "추정" = 금지!
오직 조회된 정확한 숫자만 사용
수집된 정보에 없으면 "데이터 없음"
```

### 4. 에러 처리

```python
if not intermediate_results:
    return "재무 데이터를 조회하지 못했습니다. 다시 질문해주세요."
```

## 📝 체크리스트

### Iterative RAG 작동 확인

- [ ] "비교" 질문이 iterative_rag로 라우팅되는가?
- [ ] 첫 번째 회사 데이터가 조회되는가?
- [ ] 두 번째 회사 데이터가 조회되는가?
- [ ] intermediate_results에 데이터가 쌓이는가?
- [ ] 최종 답변이 조회된 데이터만 사용하는가?

### 답변 품질 확인

- [ ] "약", "대략" 같은 추정 표현이 없는가?
- [ ] 모든 숫자가 조회된 정확한 값인가?
- [ ] 비교 분석이 논리적으로 작성되었는가?
- [ ] 인사이트가 데이터 기반인가?

## 🚀 배포 전 테스트

```bash
# 서버 재시작
cd /Users/1107625/dev/repositories/scripts/2509_LLMMVP/MVP/financial_analysis_poc_v2
uv run python main.py

# 테스트 질문들
1. "삼성전자 영업이익은?" (단일 질문 - single_shot)
2. "삼성전자와 SK하이닉스 비교" (비교 - iterative)
3. "삼성전자와 SK하이닉스의 매출액, 영업이익, 순이익 비교 분석해줘" (복합 비교 - iterative)
4. "통신 3사 재무 건전성 비교" (3개 회사 비교 - iterative)
```

## 📖 관련 문서

- `재무비율_계산_가이드.md`: 비율 계산 방법
- `복합조건_쿼리_가이드.md`: 복합 조건 SQL 작성
- `회사명_매칭_가이드.md`: 회사명 정규화
- `재무용어_매핑_가이드.md`: 재무 용어 매핑

---

**이제 비교 분석 질문도 정확한 DB 데이터로 답변합니다!** 🎉

**핵심:** LLM의 자체 지식 사용 절대 금지, 반드시 DB 조회 후 답변!

