# 복합 조건 쿼리 가이드

## 🎯 문제 해결: 여러 조건을 만족하는 기업 찾기

### 질문 예시

"영업이익 1000억이 넘고 자산이 1조 이상인 기업 추출해줘"

### 필요한 작업

1. income_statement에서 영업이익 조회
2. balance_sheet에서 자산 조회  
3. 두 조건을 모두 만족하는 기업 필터링
4. 결과를 정렬하여 표시

### 해결 방법: SQL JOIN

## 🔑 핵심 발견: 데이터 타입 이슈

### 문제

데이터가 **TEXT 타입**으로 저장되어 있고 **콤마(,)**가 포함되어 있습니다!

```
"11,361,329,000,000" (TEXT)
"1,703,589,000,000" (TEXT)
```

### 영향

```sql
-- ❌ 잘못된 비교 (텍스트로 비교)
WHERE 당기_반기_누적 > 100000000000
-- "999,618,362"가 "99,911,066,775"보다 크다고 판단됨 (사전순)

-- ✅ 올바른 비교 (콤마 제거 후 숫자로 변환)
WHERE CAST(REPLACE(당기_반기_누적, ',', '') AS REAL) > 100000000000
```

### 해결

**모든 숫자 비교에 `CAST(REPLACE(column, ',', '') AS REAL)` 사용!**

## 📊 구현된 SQL 쿼리

### 기본 예시: 영업이익 + 자산 조건

```sql
SELECT DISTINCT
    i.회사명,
    i.당기_반기_누적 as 영업이익,
    b.당기_반기말 as 자산총계
FROM income_statement i
JOIN balance_sheet b 
    ON i.회사명 = b.회사명 
    AND i.결산기준일 = b.결산기준일
WHERE i.항목명 LIKE '%영업이익%'
  AND CAST(REPLACE(i.당기_반기_누적, ',', '') AS REAL) > 100000000000  -- 1000억
  AND b.항목명 LIKE '%자산총계%'
  AND CAST(REPLACE(b.당기_반기말, ',', '') AS REAL) > 1000000000000   -- 1조
ORDER BY CAST(REPLACE(i.당기_반기_누적, ',', '') AS REAL) DESC
LIMIT 20;
```

### 실제 결과

| 회사명 | 영업이익 | 자산총계 |
|--------|---------|---------|
| SK하이닉스 | 16,653,355,000,000 | 129,087,781,000,000 |
| 삼성전자 | 11,361,329,000,000 | 504,875,185,000,000 |
| 현대자동차 | 7,235,206,000,000 | 339,702,469,000,000 |
| 한국전력공사 | 5,889,479,000,000 | 249,899,672,000,000 |
| 기아 | 5,773,354,000,000 | 93,662,226,000,000 |

## 🔍 다양한 복합 조건 예시

### 1. 매출 + 순이익 조건

```sql
-- "매출액 10조 이상, 순이익 1조 이상 기업"
SELECT DISTINCT
    i_rev.회사명,
    i_rev.당기_반기_누적 as 매출액,
    i_net.당기_반기_누적 as 순이익
FROM income_statement i_rev
JOIN income_statement i_net 
    ON i_rev.회사명 = i_net.회사명 
    AND i_rev.결산기준일 = i_net.결산기준일
WHERE i_rev.항목명 LIKE '%매출액%'
  AND CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL) > 10000000000000  -- 10조
  AND i_net.항목명 = '반기순이익'
  AND CAST(REPLACE(i_net.당기_반기_누적, ',', '') AS REAL) > 1000000000000   -- 1조
ORDER BY CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL) DESC
LIMIT 20;
```

### 2. 재무비율 조건

```sql
-- "영업이익률 10% 이상이고 부채비율 50% 미만인 기업"
SELECT DISTINCT
    i_op.회사명,
    i_op.당기_반기_누적 as 영업이익,
    i_rev.당기_반기_누적 as 매출액,
    ROUND(CAST(REPLACE(i_op.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL), 2) as 영업이익률,
    b_debt.당기_반기말 as 부채,
    b_equity.당기_반기말 as 자본,
    ROUND(CAST(REPLACE(b_debt.당기_반기말, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(b_equity.당기_반기말, ',', '') AS REAL), 2) as 부채비율
FROM income_statement i_op
JOIN income_statement i_rev 
    ON i_op.회사명 = i_rev.회사명 
    AND i_op.결산기준일 = i_rev.결산기준일
JOIN balance_sheet b_debt 
    ON i_op.회사명 = b_debt.회사명 
    AND i_op.결산기준일 = b_debt.결산기준일
JOIN balance_sheet b_equity 
    ON i_op.회사명 = b_equity.회사명 
    AND i_op.결산기준일 = b_equity.결산기준일
WHERE i_op.항목명 LIKE '%영업이익%'
  AND i_rev.항목명 LIKE '%매출액%'
  AND b_debt.항목명 = '부채총계'
  AND b_equity.항목명 = '자본총계'
  AND (CAST(REPLACE(i_op.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
       CAST(REPLACE(i_rev.당기_반기_누적, ',', '') AS REAL)) >= 10  -- 영업이익률 10%+
  AND (CAST(REPLACE(b_debt.당기_반기말, ',', '') AS REAL) * 100.0 / 
       CAST(REPLACE(b_equity.당기_반기말, ',', '') AS REAL)) < 50   -- 부채비율 50%-
ORDER BY 영업이익률 DESC
LIMIT 20;
```

### 3. ROE 조건

```sql
-- "ROE 5% 이상 기업"
SELECT DISTINCT
    i.회사명,
    i.당기_반기_누적 as 반기순이익,
    b.당기_반기말 as 자본총계,
    ROUND(CAST(REPLACE(i.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
          CAST(REPLACE(b.당기_반기말, ',', '') AS REAL), 2) as ROE
FROM income_statement i
JOIN balance_sheet b 
    ON i.회사명 = b.회사명 
    AND i.결산기준일 = b.결산기준일
WHERE i.항목명 = '반기순이익'
  AND b.항목명 = '자본총계'
  AND (CAST(REPLACE(i.당기_반기_누적, ',', '') AS REAL) * 100.0 / 
       CAST(REPLACE(b.당기_반기말, ',', '') AS REAL)) >= 5
ORDER BY ROE DESC
LIMIT 20;
```

## ⚡️ Single-shot vs Iterative RAG

### Single-shot RAG (권장) ✅

**사용 시기:**
- 복합 조건이지만 SQL JOIN으로 한 번에 처리 가능
- 데이터 조회만 필요한 경우

**예시:**
```
✅ "영업이익 1000억 넘고 자산 1조 이상 기업"
✅ "매출 10조 이상, 순이익 1조 이상 기업"
✅ "영업이익률 10% 이상, 부채비율 50% 미만 기업"
```

**장점:**
- 빠른 응답 (1번의 SQL 쿼리)
- 정확한 결과
- 효율적

### Iterative RAG

**사용 시기:**
- 데이터 조회 후 추가 분석/해석 필요
- 여러 단계의 사고 과정 필요

**예시:**
```
✅ "삼성전자와 SK하이닉스의 영업이익 비교하고 그 차이의 원인을 분석해줘"
✅ "통신 3사의 재무 건전성을 평가하고 투자 추천 의견 줘"
✅ "반도체 업종의 평균 영업이익률을 계산하고 업계 동향 분석해줘"
```

## 💡 프롬프트 가이드라인

### tools.py에 추가된 내용

```
## CRITICAL: Multiple Conditions Across Tables

복합 조건 예시:
"영업이익 1000억 넘고 자산 1조 이상인 기업"

필수 사항:
1. DISTINCT 사용 (중복 제거)
2. JOIN 조건: 회사명 AND 결산기준일
3. 콤마 제거: CAST(REPLACE(column, ',', '') AS REAL)
4. ORDER BY로 정렬
5. LIMIT으로 결과 제한

숫자 포맷:
- 1000억 = 100000000000
- 1조 = 1000000000000
- 10조 = 10000000000000
```

### graph.py 라우팅 로직

```
single_shot_rag 선택:
- "영업이익 1000억 넘고 자산 1조 이상 기업" (복합 조건이지만 SQL로 한 번에 처리)

iterative_rag 선택:
- "A와 B 비교하고 원인 분석" (조회 + 분석 필요)
```

## 🧪 테스트 케이스

### Case 1: 영업이익 + 자산

**질문:** "영업이익 1000억 넘고 자산 1조 이상 기업 추출해줘"

**라우팅:** single_shot_rag ✅

**생성 SQL:**
- income_statement + balance_sheet JOIN
- 콤마 제거 후 숫자 비교
- 영업이익 순으로 정렬

**기대 결과:**
```
SK하이닉스: 영업이익 16조, 자산 129조
삼성전자: 영업이익 11조, 자산 504조
현대자동차: 영업이익 7조, 자산 339조
...
```

### Case 2: 비율 조건

**질문:** "영업이익률 10% 이상이고 부채비율 50% 미만인 기업"

**라우팅:** single_shot_rag ✅

**생성 SQL:**
- 4개 테이블 JOIN (영업이익, 매출액, 부채, 자본)
- 비율 계산 포함
- WHERE 절에 비율 조건

### Case 3: 분석 포함

**질문:** "영업이익 1조 이상 기업 찾고, 업종별로 분석해줘"

**라우팅:** iterative_rag ✅

**처리 단계:**
1. 영업이익 1조 이상 기업 조회
2. 업종별로 그룹화
3. 업종별 특징 분석
4. 최종 인사이트 제공

## 📋 체크리스트

### SQL 작성 시

- [ ] DISTINCT 사용했는가?
- [ ] JOIN에 회사명 AND 결산기준일 모두 포함했는가?
- [ ] 숫자 비교에 CAST(REPLACE()) 사용했는가?
- [ ] ORDER BY 추가했는가?
- [ ] LIMIT 설정했는가?

### 라우팅 판단 시

- [ ] 단순 데이터 조회인가? → single_shot_rag
- [ ] 추가 분석/해석 필요한가? → iterative_rag

## 🎓 실전 팁

### 1. 숫자 단위 변환

```
1000억 = 100,000,000,000 = 100000000000
1조   = 1,000,000,000,000 = 1000000000000
10조  = 10,000,000,000,000 = 10000000000000
```

### 2. 콤마 제거 패턴

```sql
-- 항상 이 패턴 사용
CAST(REPLACE(column_name, ',', '') AS REAL)

-- WHERE 절
WHERE CAST(REPLACE(당기_반기_누적, ',', '') AS REAL) > 100000000000

-- ORDER BY 절
ORDER BY CAST(REPLACE(당기_반기_누적, ',', '') AS REAL) DESC

-- SELECT 절 (비율 계산)
ROUND(CAST(REPLACE(a, ',', '') AS REAL) * 100.0 / 
      CAST(REPLACE(b, ',', '') AS REAL), 2) as 비율
```

### 3. 결과 개수 제한

```sql
-- 기본: 20개
LIMIT 20

-- 많이 필요하면: 50개
LIMIT 50

-- 상위 10개만:
LIMIT 10
```

## 🚀 기대 효과

### Before (구현 전)

```
질문: "영업이익 1000억 넘고 자산 1조 이상 기업"
답변: "죄송합니다. 복잡한 조건은 처리할 수 없습니다."
```

### After (구현 후)

```
질문: "영업이익 1000억 넘고 자산 1조 이상 기업"
답변: "조건을 만족하는 기업은 다음과 같습니다:

1. SK하이닉스
   - 영업이익: 16조 6,533억원
   - 자산총계: 129조 877억원

2. 삼성전자
   - 영업이익: 11조 3,613억원
   - 자산총계: 504조 8,751억원

3. 현대자동차
   - 영업이익: 7조 2,352억원
   - 자산총계: 339조 7,024억원

(총 10개 기업)"
```

---

**이제 복잡한 복합 조건 쿼리도 SQL JOIN으로 정확하게 처리합니다!** 🎉

