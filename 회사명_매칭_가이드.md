# 회사명 정확 매칭 가이드

## 🎯 문제 해결: 대표 회사 vs 자회사

### 문제 상황

**질문**: "kt 영업이익은?"

**잘못된 답변** (수정 전):
```
KT밀리의서재: 84억원
KT나스미디어: 50억원
```

**올바른 답변** (수정 후):
```
케이티(KT 본사)의 영업이익: 1조 7,035억원
```

### 원인 분석

#### 기존 동작 (❌)
```
사용자: "kt 영업이익은?"
  ↓
벡터 검색: "kt" 관련 모든 회사 찾음
  ["케이티", "KT밀리의서재", "KT나스미디어", "KT지니뮤직", ...]
  ↓
SQL 생성: WHERE 회사명 LIKE '%kt%' 또는 '%KT%'
  ↓
결과: 모든 KT 관련 회사 (자회사 포함)
```

#### 수정 후 동작 (✅)
```
사용자: "kt 영업이익은?"
  ↓
프롬프트 가이드: "kt" → "케이티" (대표 회사)
  ↓
SQL 생성: WHERE 회사명 = '케이티'
  ↓
결과: KT 본사 데이터만 정확히 반환
```

## 📋 주요 회사명 매핑

### 통신 3사

| 사용자 입력 | 정확한 DB 회사명 | SQL 조건 | 비고 |
|------------|----------------|----------|------|
| "kt", "KT", "케이티" | 케이티 | `회사명 = '케이티'` | KT 본사 |
| "skt", "SKT", "sk텔레콤" | SK텔레콤 | `회사명 = 'SK텔레콤'` | SKT 본사 |
| "lgu+", "LG유플러스" | LG유플러스 | `회사명 = 'LG유플러스'` | LGU+ |

### 전자/IT

| 사용자 입력 | 정확한 DB 회사명 | SQL 조건 | 비고 |
|------------|----------------|----------|------|
| "삼성", "삼성전자" | 삼성전자 | `회사명 = '삼성전자'` | 삼성 본사 |
| "lg전자", "LG" | 엘지전자 or LG전자 | `회사명 = '엘지전자'` | LG전자 |
| "sk하이닉스", "하이닉스" | SK하이닉스 | `회사명 = 'SK하이닉스'` | SK하이닉스 |

### KT 관련 회사 구분

```
케이티 (KT 본사) ← 사용자가 "kt"라고 하면 이것을 의미!
├── KT밀리의서재 (자회사)
├── KT나스미디어 (자회사)
├── KT지니뮤직 (자회사)
├── KTcs (자회사)
├── KTis (자회사)
└── 기타...
```

### 삼성 관련 회사 구분

```
삼성전자 (삼성 본사) ← 사용자가 "삼성"이라고 하면 이것을 의미!
├── 삼성SDI (자회사)
├── 삼성E&A (자회사)
├── 삼성생명 (계열사)
├── 삼성화재 (계열사)
└── 기타...
```

## 🔧 구현된 규칙

### 1. 정확한 매칭 (= 연산자)

```sql
-- ✅ 올바름: 정확히 "케이티"만 매칭
WHERE 회사명 = '케이티'

-- ❌ 잘못됨: 모든 KT 포함 회사 매칭
WHERE 회사명 LIKE '%KT%'
WHERE 회사명 LIKE '%케이티%'
```

### 2. 대표 회사 우선순위

```
우선순위:
1순위: 대표 회사 (본사)
2순위: 주요 자회사
3순위: 기타 관련 회사

예시:
"kt" → "케이티" (KT 본사)
"kt밀리의서재" → 명시적으로 자회사 지정한 경우만
```

### 3. 항목명은 LIKE 사용

```sql
-- 회사명: = (정확히 일치)
-- 항목명: LIKE (패턴 매칭)
SELECT 회사명, 항목명, 당기_반기_누적
FROM income_statement
WHERE 회사명 = '케이티'          -- = 사용
  AND 항목명 LIKE '%영업이익%'   -- LIKE 사용
```

## 🧪 테스트 예시

### Case 1: KT 본사 조회

**질문**: "kt 영업이익은?"

**기대 SQL**:
```sql
SELECT 회사명, 항목명, 당기_반기_누적
FROM income_statement
WHERE 회사명 = '케이티'
  AND 항목명 LIKE '%영업이익%'
```

**기대 결과**:
```
케이티의 2025년 상반기 영업이익은 1조 7,035억원입니다.
```

### Case 2: 자회사 명시적 조회

**질문**: "KT밀리의서재의 영업이익은?"

**기대 SQL**:
```sql
SELECT 회사명, 항목명, 당기_반기_누적
FROM income_statement
WHERE 회사명 = 'KT밀리의서재'
  AND 항목명 LIKE '%영업이익%'
```

**기대 결과**:
```
KT밀리의서재의 2025년 상반기 영업이익은 84억원입니다.
```

### Case 3: 통신 3사 비교

**질문**: "통신 3사의 영업이익 비교해줘"

**기대 SQL**:
```sql
SELECT 회사명, 항목명, 당기_반기_누적
FROM income_statement
WHERE 회사명 IN ('케이티', 'SK텔레콤', 'LG유플러스')
  AND 항목명 LIKE '%영업이익%'
```

## 💡 프롬프트 개선 사항

### 추가된 가이드라인

```
## CRITICAL: Company Name Mapping (대표 회사명 우선)

Telecom Companies:
- "kt", "KT" → 회사명 = '케이티' (NOT KT밀리의서재, KT나스미디어)
- "skt", "SKT" → 회사명 = 'SK텔레콤'
- "lgu+" → 회사명 = 'LG유플러스'

Important Rules:
1. When user mentions just "KT", they mean "케이티" (main company)
2. Always use = operator for 회사명, NOT LIKE
3. Only use LIKE for 항목명 (item names)
4. Prioritize main/parent companies over subsidiaries
```

## 🔍 검증 방법

### DB에서 직접 확인

```bash
# KT 관련 모든 회사 목록
sqlite3 financial_data.db "SELECT DISTINCT 회사명 FROM income_statement WHERE 회사명 LIKE '%KT%' OR 회사명 LIKE '%케이티%' ORDER BY 회사명;"

# 케이티(KT 본사) 영업이익
sqlite3 financial_data.db "SELECT 회사명, 항목명, 당기_반기_누적 FROM income_statement WHERE 회사명 = '케이티' AND 항목명 LIKE '%영업이익%';"

# 결과: 케이티|영업이익(손실)|1,703,589,000,000
```

## 📊 실제 데이터 비교

| 회사명 | 영업이익 (2025 상반기) | 구분 |
|--------|----------------------|------|
| 케이티 | 1조 7,035억원 | ✅ KT 본사 |
| KT밀리의서재 | 84억원 | 자회사 |
| KT나스미디어 | 50억원 | 자회사 |

**사용자가 "kt"라고 할 때는 당연히 1조 7천억원의 본사를 의미합니다!**

## 🎯 핵심 원칙

1. **약어/영문명 → 정식 한글 대표사명**
   - "kt" → "케이티"
   - "skt" → "SK텔레콤"
   - "삼성" → "삼성전자"

2. **= 연산자 사용 (LIKE 금지)**
   - `회사명 = '케이티'` ✅
   - `회사명 LIKE '%kt%'` ❌

3. **대표 회사 우선**
   - 본사 > 자회사 > 계열사

4. **명시적 지정만 자회사**
   - "kt" → 본사
   - "kt밀리의서재" → 자회사 (명시적)

---

**이제 "kt 영업이익은?" 질문에 정확히 KT 본사 데이터를 반환합니다!** 🎉

